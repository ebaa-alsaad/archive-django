{% extends "base.html" %}
{% block content %}

<input type="file" id="file-input" multiple>
<button onclick="uploadFiles()">رفع الملفات</button>
<div id="uploads"></div>

<script>
function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta && meta.getAttribute('content')) return meta.getAttribute('content');

    // fallback to cookie
    function getCookie(name) {
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? decodeURIComponent(v.pop()) : null;
    }
    return getCookie('csrftoken');
}

const csrftoken = getCsrfToken();

function uploadFiles(){
    const files = document.getElementById('file-input').files;
    for(let i=0;i<files.length;i++){
        uploadFile(files[i]);
    }
} 

function uploadFile(file){
    const container = document.createElement('div');
    container.classList.add('progress-container');

    const title = document.createElement('div');
    title.textContent = file.name;

    const bar = document.createElement('div');
    bar.classList.add('progress-bar');

    const statusText = document.createElement('div');
    statusText.classList.add('status-text');
    statusText.textContent = 'انتظار...';

    container.appendChild(title);
    container.appendChild(bar);
    container.appendChild(statusText);

    document.getElementById('uploads').appendChild(container);

    const formData = new FormData();
    formData.append('file', file);

    // استخدم URL المطلق بدلاً من template tag
    const uploadUrl = '/uploads/create/'; // أو window.location.origin + '/uploads/create/'
    
    fetch(uploadUrl, {
        method: 'POST',
        body: formData,
        headers: { 
            'X-CSRFToken': csrftoken,
            // أضف Accept header للـ JSON
            'Accept': 'application/json'
        }
    })
    .then(response => {
        // تحقق من حالة الاستجابة أولاً
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if(data.success){
            const upload_id = data.uploads[0].id;
            statusText.textContent = 'جاري المعالجة...';
            
            // استخدم URL صحيح للـ status
            const statusUrl = `/uploads/${upload_id}/status/`;
            
            const interval = setInterval(() => {
                fetch(statusUrl)
                .then(r => {
                    if (!r.ok) throw new Error(`Status check failed: ${r.status}`);
                    return r.json();
                })
                .then(p => {
                    if(p.success){
                        bar.style.width = p.progress + '%';
                        bar.textContent = Math.round(p.progress) + '%';
                        statusText.textContent = p.status;
                        
                        if(p.progress >= 100 || p.status === 'failed' || p.status === 'completed') {
                            clearInterval(interval);
                        }
                        
                        if(p.status === 'failed'){
                            bar.style.background = 'red';
                            statusText.textContent = 'فشل في المعالجة: ' + p.message;
                        }
                    } else {
                        statusText.textContent = 'خطأ في الحالة: ' + (p.message || 'غير معروف');
                        clearInterval(interval);
                    }
                })
                .catch(err => {
                    console.error('Status check error:', err);
                    clearInterval(interval);
                });
            }, 1000);
        } else {
            statusText.textContent = data.message || 'خطأ غير معروف';
            bar.style.background = 'red';
        }
    })
    .catch(err => {
        console.error('Upload error:', err);
        statusText.textContent = 'خطأ في رفع الملف: ' + err.message;
        bar.style.background = 'red';
    });
}

</script>

<style>
.progress-container { margin-bottom:10px; }
.progress-bar { width:0%; height:20px; background:#4caf50; text-align:center; color:white; }
.status-text { font-size: 12px; margin-top: 2px; }
</style>

{% endblock %}
